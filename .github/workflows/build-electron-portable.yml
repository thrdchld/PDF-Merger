name: Build Windows 7 (32-bit) portable EXE with Electron

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-electron-win7-32:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Download FFmpeg (32-bit)
        run: |
          # Download FFmpeg essentials 32-bit build
          $ErrorActionPreference = "Stop"
          $ProgressPreference = 'SilentlyContinue'
          $ffmpegUrl = "https://github.com/defisym/FFmpeg-Builds-Win32/releases/download/latest/ffmpeg-master-latest-win32-gpl.zip"
          $zipPath = "${{ github.workspace }}\ffmpeg.zip"
          $extractPath = "${{ github.workspace }}\ffmpeg-extracted"
          
          Write-Host "Downloading FFmpeg from $ffmpegUrl"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $zipPath
          
          $shell = New-Object -com shell.application
          $zip = $shell.NameSpace($zipPath)
          $shell.NameSpace($extractPath).CopyHere($zip.items(), 16)
          
          # Find and copy ffmpeg.dll to workspace root
          $ffmpegDll = Get-ChildItem -Path $extractPath -Filter "ffmpeg.dll" -Recurse
          if ($ffmpegDll) {
            Copy-Item -Path $ffmpegDll.FullName -Destination "${{ github.workspace }}\ffmpeg.dll"
            Write-Host "Copied ffmpeg.dll successfully"
          } else {
            Write-Host "Warning: ffmpeg.dll not found in archive"
          }
          
          # Cleanup
          Remove-Item -Path $zipPath
          Remove-Item -Path $extractPath -Recurse

      - name: Install dependencies
        run: |
          npm install

      - name: Build 32-bit portable EXE with electron-builder
        run: |
          npm run build

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf-merger-portable-exe
          path: dist/*.exe
